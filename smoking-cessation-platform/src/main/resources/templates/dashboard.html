<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Người Dùng</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f7f6;
            margin: 0;
            padding: 0;
            color: #333;
        }

        .navbar {
            background-color: #007bff;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .navbar .logo {
            color: white;
            text-decoration: none;
            font-size: 1.5em;
            font-weight: bold;
        }

        .navbar .nav-links {
            list-style: none;
            margin: 0;
            padding: 0;
            display: flex;
        }

        .navbar .nav-links li {
            margin-right: 25px;
        }

        .navbar .nav-links a {
            color: white;
            text-decoration: none;
            font-size: 1.1em;
            transition: color 0.3s ease;
        }

        .navbar .nav-links a:hover {
            color: #e0e0e0;
        }

        .main-content {
            padding: 20px;
            max-width: 1200px;
            margin: 20px auto;
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        h1, h2 {
            color: #007bff;
            text-align: center;
            margin-bottom: 25px;
        }

        .dashboard-sections {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .card {
            background-color: #f8f9fa;
            border: 1px solid #e2e6ea;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 1px 5px rgba(0, 0, 0, 0.05);
            text-align: center;
        }

        .card h3 {
            color: #0056b3;
            margin-bottom: 15px;
            font-size: 1.4em;
        }

        .card p {
            font-size: 1.1em;
            color: #555;
            line-height: 1.6;
        }

        .card .highlight {
            font-size: 1.6em;
            font-weight: bold;
            color: #28a745; /* Green for positive numbers */
        }

        .action-buttons {
            text-align: center;
            margin-top: 30px;
        }

        .action-buttons a, .action-buttons button {
            display: inline-block;
            background-color: #28a745;
            color: white;
            padding: 12px 25px;
            border-radius: 5px;
            text-decoration: none;
            font-size: 1.1em;
            margin: 0 10px;
            transition: background-color 0.3s ease;
            border: none;
            cursor: pointer;
        }

        .action-buttons a:hover, .action-buttons button:hover {
            background-color: #218838;
        }

        .action-buttons .btn-secondary {
            background-color: #6c757d;
        }

        .action-buttons .btn-secondary:hover {
            background-color: #5a6268;
        }

        .logout-form {
            display: inline-block;
            margin-left: 20px;
        }

        .logout-form button {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
        }

        .logout-form button:hover {
            background-color: #c82333;
        }

        .achievements-section {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .achievement-item {
            background-color: #e9f5ff;
            border: 1px solid #cce5ff;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .achievement-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .achievement-item img {
            width: 60px;
            height: 60px;
            margin-bottom: 10px;
            object-fit: contain;
        }

        .achievement-item h4 {
            font-size: 1.1em;
            color: #0056b3;
            margin-bottom: 5px;
        }

        .achievement-item p {
            font-size: 0.9em;
            color: #666;
        }

        /* Styles cho Alert Popup */
        .alert-popup {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 30px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease, visibility 0.5s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-popup.show {
            opacity: 1;
            visibility: visible;
        }

        .alert-popup.success {
            background-color: #28a745; /* Green */
        }

        .alert-popup.error {
            background-color: #dc3545; /* Red */
        }

        .alert-popup.info {
            background-color: #007bff; /* Blue */
        }

        .alert-popup.warning {
            background-color: #ffc107; /* Yellow */
            color: #333;
        }

        .alert-popup .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5em;
            cursor: pointer;
            margin-left: 15px;
            padding: 0 5px;
            line-height: 1;
        }
        .alert-popup.warning .close-btn {
            color: #333;
        }

        /* Chart Styles */
        .chart-container {
            width: 100%;
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
            background-color: #f8f9fa;
            border: 1px solid #e2e6ea;
            border-radius: 8px;
            box-shadow: 0 1px 5px rgba(0, 0, 0, 0.05);
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <a th:href="@{/}" class="logo">Quit Smoking</a>
        <ul class="nav-links">
            <li><a th:href="@{/dashboard}">Dashboard</a></li>
            <li><a th:href="@{/user-profile}">Hồ Sơ Của Tôi</a></li>
            <li><a th:href="@{/smoking/log}">Ghi Nhận Hút Thuốc</a></li>
            <li><a th:href="@{/smoking/quit-plan}">Lập Kế Hoạch Cai</a></li>
            <li><a th:href="@{/smoking/quit-plans}">Kế Hoạch Của Tôi</a></li>
            <li><a th:href="@{/feedback}">Gửi Phản Hồi</a></li>
            <li sec:authorize="hasRole('ADMIN')"><a th:href="@{/admin/dashboard}">Admin Dashboard</a></li>
            <li>
                <form th:action="@{/logout}" method="post" class="logout-form">
                    <button type="submit">Đăng xuất</button>
                </form>
            </li>
        </ul>
    </nav>

    <div class="main-content">
        <h1>Bảng điều khiển của bạn</h1>

        <div id="alertContainer"></div>

        <div class="dashboard-sections">
            <div class="card">
                <h3>Ngày không hút thuốc</h3>
                <p>Bạn đã không hút thuốc được <span class="highlight" th:text="${smokeFreeDays}">0</span> ngày.</p>
            </div>
            <div class="card">
                <h3>Tiền tiết kiệm được</h3>
                <p>Bạn đã tiết kiệm được <span class="highlight" th:text="${#numbers.formatDecimal(moneySaved, 0, 'COMMA', 0, 'POINT')} + ' VND'">0 VND</span>.</p>
            </div>
            <div class="card">
                <h3>Lần hút thuốc gần nhất</h3>
                <p th:if="${latestSmokingLog}">
                    Ngày: <span th:text="${#temporals.format(latestSmokingLog.date, 'dd/MM/yyyy HH:mm')}"></span><br/>
                    Số điếu: <span th:text="${latestSmokingLog.cigarettesSmoked}"></span> điếu
                </p>
                <p th:unless="${latestSmokingLog}">
                    Bạn chưa ghi nhận lần hút thuốc nào.
                </p>
            </div>
        </div>

        <div class="chart-container">
            <h2>Số điếu thuốc hút hàng tuần</h2>
            <canvas id="weeklySmokingChart"></canvas>
        </div>

        <div class="chart-container">
            <h2>Tiền tiết kiệm tích lũy</h2>
            <canvas id="cumulativeMoneySavedChart"></canvas>
        </div>

        <div class="achievements-section">
            <h2>Thành tích của bạn</h2>
            <div th:if="${userAchievements.isEmpty()}">
                <p>Bạn chưa đạt được thành tích nào. Hãy tiếp tục hành trình cai thuốc để mở khóa các huy hiệu!</p>
            </div>
            <div th:unless="${userAchievements.isEmpty()}" class="achievements-grid">
                <div class="achievement-item" th:each="userAchievement : ${userAchievements}">
                    <img th:src="${userAchievement.achievement.iconUrl}" alt="Icon" th:title="${userAchievement.achievement.description}">
                    <h4 th:text="${userAchievement.achievement.name}"></h4>
                    <p th:text="${#temporals.format(userAchievement.dateAchieved, 'dd/MM/yyyy')}"></p>
                </div>
            </div>
        </div>

        <div class="action-buttons">
            <a th:href="@{/smoking/log}" class="btn-primary">Ghi nhận hoạt động hút thuốc</a>
            <a th:href="@{/smoking/quit-plan}" class="btn-secondary">Lập kế hoạch cai thuốc</a>
        </div>
    </div>

    <script th:inline="javascript">
        /*<![CDATA[*/
        // Dữ liệu được truyền từ backend
        const successMessage = /*[[${successMessage}]]*/ null;
        const errorMessage = /*[[${errorMessage}]]*/ null;
        const latestSmokingLog = /*[[${latestSmokingLog}]]*/ null;
        const smokeFreeDays = /*[[${smokeFreeDays}]]*/ 0;
        const moneySaved = /*[[${moneySaved}]]*/ 0.0; // Đã đổi tên
        const userAchievements = /*[[${userAchievements}]]*/ [];
        const userId = /*[[${userId}]]*/ null; // Lấy userId để gọi API

        /*]]>*/

        const alertContainer = document.getElementById('alertContainer');

        function showAlert(message, type = 'info', duration = 5000) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert-popup ${type}`;
            alertDiv.innerHTML = `
                <span>${message}</span>
                <button class="close-btn">&times;</button>
            `;
            alertContainer.appendChild(alertDiv);

            setTimeout(() => {
                alertDiv.classList.add('show');
            }, 100);

            const timeoutId = setTimeout(() => {
                alertDiv.classList.remove('show');
                alertDiv.addEventListener('transitionend', () => alertDiv.remove());
            }, duration);

            alertDiv.querySelector('.close-btn').addEventListener('click', () => {
                clearTimeout(timeoutId);
                alertDiv.classList.remove('show');
                alertDiv.addEventListener('transitionend', () => alertDiv.remove());
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Hiển thị các thông báo từ redirect (nếu có)
            if (successMessage) {
                showAlert(successMessage, 'success');
            }
            if (errorMessage) {
                showAlert(errorMessage, 'error');
            }

            // Logic hiển thị thông báo ưu tiên
            let priorityAlertShown = false;

            // 1. Ưu tiên kiểm tra và thông báo huy hiệu mới
            if (userAchievements && userAchievements.length > 0) {
                const newestAchievement = userAchievements[userAchievements.length - 1];
                const achievementDate = new Date(newestAchievement.dateAchieved);
                const now = new Date();
                
                // Kiểm tra nếu huy hiệu được trao trong vòng 24 giờ qua (hoặc một khoảng thời gian hợp lý)
                // Cần đảm bảo rằng dateAchieved từ backend không phải là một chuỗi rỗng hoặc null.
                if (newestAchievement.dateAchieved && Math.abs(now - achievementDate) / 36e5 < 24) { // 36e5 = 1000 * 60 * 60
                    const achievementName = newestAchievement.achievement.name;
                    showAlert(`🎖️ Chúc mừng! Bạn vừa đạt được huy hiệu mới: "${achievementName}"!`, 'success', 8000);
                    priorityAlertShown = true;
                }
            }

            // 2. Nếu không có thông báo huy hiệu mới, hiển thị các thông báo khác
            if (!priorityAlertShown) {
                if (smokeFreeDays > 0) {
                    showAlert(`🎉 Bạn đã không hút thuốc được ${smokeFreeDays} ngày và tiết kiệm được ${moneySaved.toLocaleString('vi-VN')} VND!`, 'info');
                } else if (smokeFreeDays === 0 && latestSmokingLog && latestSmokingLog.cigarettesSmoked > 0) {
                    // Nếu ngày không hút thuốc là 0 và có log hút thuốc gần đây
                    showAlert(`Bạn đã ghi nhận hút thuốc gần đây. Đừng nản lòng, hãy bắt đầu lại ngay hôm nay!`, 'warning', 10000);
                } else if (smokeFreeDays === 0 && !latestSmokingLog && moneySaved === 0) {
                    // Nếu chưa có log nào và chưa tiết kiệm được tiền
                    showAlert('Chào mừng bạn! Hãy cập nhật hồ sơ và ghi nhận hoạt động hút thuốc để bắt đầu hành trình của bạn!', 'info', 10000);
                }
            }

            // --- Fetch và Vẽ biểu đồ ---
            if (userId) { // Đảm bảo userId tồn tại trước khi gọi API
                // Biểu đồ số điếu thuốc hút hàng tuần
                fetch(`/api/smoking/stats/weekly-chart-data?userId=${userId}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok ' + response.statusText);
                        }
                        return response.json();
                    })
                    .then(data => {
                        const ctx = document.getElementById('weeklySmokingChart').getContext('2d');
                        new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: data.labels,
                                datasets: [{
                                    label: data.title,
                                    data: data.data,
                                    backgroundColor: 'rgba(0, 123, 255, 0.7)',
                                    borderColor: 'rgba(0, 123, 255, 1)',
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                plugins: {
                                    title: {
                                        display: true,
                                        text: data.title
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        title: {
                                            display: true,
                                            text: 'Số điếu'
                                        }
                                    },
                                    x: {
                                        title: {
                                            display: true,
                                            text: 'Tuần'
                                        }
                                    }
                                }
                            }
                        });
                    })
                    .catch(error => {
                        console.error('Error fetching weekly smoking stats:', error);
                        showAlert('Không thể tải dữ liệu biểu đồ tuần.', 'error');
                    });

                // Biểu đồ tiền tiết kiệm tích lũy
                fetch(`/api/smoking/stats/money-saved-chart-data?userId=${userId}&daysToLookBack=90`) // Lấy 90 ngày gần nhất
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok ' + response.statusText);
                        }
                        return response.json();
                    })
                    .then(data => {
                        const ctx = document.getElementById('cumulativeMoneySavedChart').getContext('2d');
                        new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: data.labels,
                                datasets: [{
                                    label: data.title,
                                    data: data.data,
                                    backgroundColor: 'rgba(40, 167, 69, 0.2)', // Light green fill
                                    borderColor: 'rgba(40, 167, 69, 1)',
                                    borderWidth: 2,
                                    fill: true,
                                    tension: 0.1
                                }]
                            },
                            options: {
                                responsive: true,
                                plugins: {
                                    title: {
                                        display: true,
                                        text: data.title
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        title: {
                                            display: true,
                                            text: 'Số tiền (VND)'
                                        }
                                    },
                                    x: {
                                        title: {
                                            display: true,
                                            text: 'Ngày'
                                        },
                                        // Cải thiện hiển thị nhãn ngày nếu quá nhiều
                                        ticks: {
                                            autoSkip: true,
                                            maxTicksLimit: 10 // Giới hạn số lượng nhãn trên trục X
                                        }
                                    }
                                }
                            }
                        });
                    })
                    .catch(error => {
                        console.error('Error fetching cumulative money saved stats:', error);
                        showAlert('Không thể tải dữ liệu biểu đồ tiền tiết kiệm.', 'error');
                    });

            } else {
                console.error("User ID not available for API calls.");
                showAlert('Không thể tải dữ liệu biểu đồ. Vui lòng đăng nhập lại.', 'error');
            }
        });
    </script>
</body>
</html>