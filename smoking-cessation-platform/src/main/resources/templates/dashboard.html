<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Người Dùng</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f7f6;
            margin: 0;
            padding: 0;
            color: #333;
        }

        .navbar {
            background-color: #007bff;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .navbar .logo {
            color: white;
            text-decoration: none;
            font-size: 1.5em;
            font-weight: bold;
        }

        .navbar .nav-links {
            list-style: none;
            margin: 0;
            padding: 0;
            display: flex;
        }

        .navbar .nav-links li {
            margin-right: 25px;
        }

        .navbar .nav-links a {
            color: white;
            text-decoration: none;
            font-size: 1.1em;
            transition: color 0.3s ease;
        }

        .navbar .nav-links a:hover {
            color: #e0e0e0;
        }

        .main-content {
            padding: 20px;
            max-width: 1200px;
            margin: 20px auto;
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        h1, h2 {
            color: #007bff;
            text-align: center;
            margin-bottom: 25px;
        }

        .dashboard-sections {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .card {
            background-color: #f8f9fa;
            border: 1px solid #e2e6ea;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 1px 5px rgba(0, 0, 0, 0.05);
            text-align: center;
        }

        .card h3 {
            color: #0056b3;
            margin-bottom: 15px;
            font-size: 1.4em;
        }

        .card p {
            font-size: 1.1em;
            color: #555;
            line-height: 1.6;
        }

        .card .highlight {
            font-size: 1.6em;
            font-weight: bold;
            color: #28a745; /* Green for positive numbers */
        }

        .action-buttons {
            text-align: center;
            margin-top: 30px;
        }

        .action-buttons a, .action-buttons button {
            display: inline-block;
            background-color: #28a745;
            color: white;
            padding: 12px 25px;
            border-radius: 5px;
            text-decoration: none;
            font-size: 1.1em;
            margin: 0 10px;
            transition: background-color 0.3s ease;
            border: none;
            cursor: pointer;
        }

        .action-buttons a:hover, .action-buttons button:hover {
            background-color: #218838;
        }

        .action-buttons .btn-secondary {
            background-color: #6c757d;
        }

        .action-buttons .btn-secondary:hover {
            background-color: #5a6268;
        }

        .logout-form {
            display: inline-block;
            margin-left: 20px;
        }

        .logout-form button {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
        }

        .logout-form button:hover {
            background-color: #c82333;
        }

        .achievements-section {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .achievement-item {
            background-color: #e9f5ff;
            border: 1px solid #cce5ff;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .achievement-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .achievement-item img {
            width: 60px;
            height: 60px;
            margin-bottom: 10px;
            object-fit: contain;
        }

        .achievement-item h4 {
            font-size: 1.1em;
            color: #0056b3;
            margin-bottom: 5px;
        }

        .achievement-item p {
            font-size: 0.9em;
            color: #666;
        }

        /* Styles cho Alert Popup */
        .alert-popup {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 30px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease, visibility 0.5s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-popup.show {
            opacity: 1;
            visibility: visible;
        }

        .alert-popup.success {
            background-color: #28a745; /* Green */
        }

        .alert-popup.error {
            background-color: #dc3545; /* Red */
        }

        .alert-popup.info {
            background-color: #007bff; /* Blue */
        }

        .alert-popup.warning {
            background-color: #ffc107; /* Yellow */
            color: #333;
        }

        .alert-popup .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5em;
            cursor: pointer;
            margin-left: 15px;
            padding: 0 5px;
            line-height: 1;
        }
        .alert-popup.warning .close-btn {
            color: #333;
        }

    </style>
</head>
<body>
    <nav class="navbar">
        <a th:href="@{/}" class="logo">Quit Smoking</a>
        <ul class="nav-links">
            <li><a th:href="@{/dashboard}">Dashboard</a></li>
            <li><a th:href="@{/user-profile}">Hồ Sơ Của Tôi</a></li>
            <li><a th:href="@{/smoking/log}">Ghi Nhận Hút Thuốc</a></li>
            <li><a th:href="@{/smoking/quit-plan}">Lập Kế Hoạch Cai</a></li>
            <li><a th:href="@{/smoking/quit-plans}">Kế Hoạch Của Tôi</a></li>
            <li><a th:href="@{/feedback}">Gửi Phản Hồi</a></li>
            <li sec:authorize="hasRole('ADMIN')"><a th:href="@{/admin/dashboard}">Admin Dashboard</a></li>
            <li>
                <form th:action="@{/logout}" method="post" class="logout-form">
                    <button type="submit">Đăng xuất</button>
                </form>
            </li>
        </ul>
    </nav>

    <div class="main-content">
        <h1>Bảng điều khiển của bạn</h1>

        <div id="alertContainer"></div>

        <div class="dashboard-sections">
            <div class="card">
                <h3>Ngày không hút thuốc</h3>
                <p>Bạn đã không hút thuốc được <span class="highlight" th:text="${smokeFreeDays}">0</span> ngày.</p>
            </div>
            <div class="card">
                <h3>Tiền tiết kiệm được</h3>
                <p>Bạn đã tiết kiệm được <span class="highlight" th:text="${#numbers.formatDecimal(potentialMoneySaved, 0, 'COMMA', 0, 'POINT')} + ' VND'">0 VND</span>.</p>
            </div>
            <div class="card">
                <h3>Lần hút thuốc gần nhất</h3>
                <p th:if="${latestSmokingLog}">
                    Ngày: <span th:text="${#temporals.format(latestSmokingLog.date, 'dd/MM/yyyy HH:mm')}"></span><br/>
                    Số điếu: <span th:text="${latestSmokingLog.cigarettesSmoked}"></span> điếu
                </p>
                <p th:unless="${latestSmokingLog}">
                    Bạn chưa ghi nhận lần hút thuốc nào.
                </p>
            </div>
        </div>

        <div class="achievements-section">
            <h2>Thành tích của bạn</h2>
            <div th:if="${userAchievements.isEmpty()}">
                <p>Bạn chưa đạt được thành tích nào. Hãy tiếp tục hành trình cai thuốc để mở khóa các huy hiệu!</p>
            </div>
            <div th:unless="${userAchievements.isEmpty()}" class="achievements-grid">
                <div class="achievement-item" th:each="userAchievement : ${userAchievements}">
                    <img th:src="${userAchievement.achievement.iconUrl}" alt="Icon" th:title="${userAchievement.achievement.description}">
                    <h4 th:text="${userAchievement.achievement.name}"></h4>
                    <p th:text="${#temporals.format(userAchievement.dateAchieved, 'dd/MM/yyyy')}"></p>
                </div>
            </div>
        </div>

        <div class="action-buttons">
            <a th:href="@{/smoking/log}" class="btn-primary">Ghi nhận hoạt động hút thuốc</a>
            <a th:href="@{/smoking/quit-plan}" class="btn-secondary">Lập kế hoạch cai thuốc</a>
        </div>
    </div>

    <script th:inline="javascript">
        /*<![CDATA[*/
        const successMessage = /*[[${successMessage}]]*/ null;
        const errorMessage = /*[[${errorMessage}]]*/ null;
        const latestSmokingLog = /*[[${latestSmokingLog}]]*/ null;
        const smokeFreeDays = /*[[${smokeFreeDays}]]*/ 0;
        const potentialMoneySaved = /*[[${potentialMoneySaved}]]*/ 0.0;
        const userAchievements = /*[[${userAchievements}]]*/ [];
        /*]]>*/

        const alertContainer = document.getElementById('alertContainer');

        function showAlert(message, type = 'info', duration = 5000) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert-popup ${type}`;
            alertDiv.innerHTML = `
                <span>${message}</span>
                <button class="close-btn">&times;</button>
            `;
            alertContainer.appendChild(alertDiv);

            // Show the alert
            setTimeout(() => {
                alertDiv.classList.add('show');
            }, 100); // Small delay to allow CSS transition

            // Auto-hide
            if (duration > 0) {
                setTimeout(() => {
                    alertDiv.classList.remove('show');
                    alertDiv.addEventListener('transitionend', () => alertDiv.remove());
                }, duration);
            }

            // Close button functionality
            alertDiv.querySelector('.close-btn').addEventListener('click', () => {
                alertDiv.classList.remove('show');
                alertDiv.addEventListener('transitionend', () => alertDiv.remove());
            });
        }

        // Logic hiển thị thông báo
        document.addEventListener('DOMContentLoaded', () => {
            if (successMessage) {
                showAlert(successMessage, 'success');
            }
            if (errorMessage) {
                showAlert(errorMessage, 'error');
            }

            // Thông báo về số ngày không hút thuốc và tiền tiết kiệm
            if (smokeFreeDays > 0) {
                showAlert(`Chúc mừng! Bạn đã không hút thuốc được ${smokeFreeDays} ngày và tiết kiệm được ${potentialMoneySaved.toLocaleString('vi-VN')} VND!`, 'success');
            } else if (smokeFreeDays === 0 && latestSmokingLog) {
                 // Nếu smokeFreeDays là 0 và có log hút thuốc gần nhất, có thể người dùng vừa tái nghiện
                 const lastSmokeDate = new Date(latestSmokingLog.date);
                 const now = new Date();
                 // Kiểm tra nếu log gần nhất là trong hôm nay hoặc hôm qua
                 const diffTime = Math.abs(now - lastSmokeDate);
                 const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                 if (diffDays <= 1) { // Nếu log là hôm nay hoặc hôm qua
                     showAlert(`Bạn đã ghi nhận hút thuốc vào ngày ${lastSmokeDate.toLocaleString('vi-VN')}. Đừng nản lòng, hãy bắt đầu lại ngay hôm nay!`, 'warning', 10000);
                 } else {
                     // Nếu không có smokeFreeDays và log cuối cùng đã lâu, có thể họ chưa thiết lập thông tin cai thuốc hoặc đã ngừng sử dụng tính năng
                     // Hoặc có thể họ đã hút thuốc gần đây nhưng chưa đạt được ngày cai thuốc đáng kể
                     showAlert(`Hãy tiếp tục hành trình cai thuốc của bạn! Lần cuối bạn hút thuốc là vào ngày ${lastSmokeDate.toLocaleString('vi-VN')}.`, 'info', 10000);
                 }
            } else if (smokeFreeDays === 0 && !latestSmokingLog && potentialMoneySaved === 0) {
                // Nếu không có dữ liệu nào liên quan đến cai thuốc hoặc ghi nhận hút thuốc
                showAlert('Chào mừng bạn đến với dashboard! Hãy cập nhật hồ sơ và ghi nhận hoạt động hút thuốc để bắt đầu hành trình cai thuốc của bạn!', 'info', 10000);
            }


            // Thông báo huy hiệu mới
            if (userAchievements && userAchievements.length > 0) {
                // Giả định rằng huy hiệu mới nhất là cái cuối cùng trong danh sách (nếu sắp xếp theo dateAchieved DESC)
                // Hiện tại, ta sẽ thông báo tất cả các huy hiệu đã đạt được (hoặc lọc ra những cái mới nhất nếu cần)
                userAchievements.forEach(ua => {
                    const achievementName = ua.achievement.name;
                    showAlert(`Bạn đã đạt được thành tích: "${achievementName}"!`, 'success', 7000);
                });
            }

        });
    </script>
</body>
</html>